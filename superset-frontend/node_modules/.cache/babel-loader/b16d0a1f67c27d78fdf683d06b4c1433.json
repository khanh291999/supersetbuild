{"ast":null,"code":"/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport {\nCUSTOM_OPERATORS,\nOperators,\nOPERATOR_ENUM_TO_OPERATOR_TYPE } from\n'src/explore/constants';\nimport { getSimpleSQLExpression } from 'src/explore/exploreUtils';\n\nexport const EXPRESSION_TYPES = {\n  SIMPLE: 'SIMPLE',\n  SQL: 'SQL' };\n\n\nexport const CLAUSES = {\n  HAVING: 'HAVING',\n  WHERE: 'WHERE' };\n\n\nconst OPERATORS_TO_SQL = {\n  '==': '=',\n  '!=': '<>',\n  '>': '>',\n  '<': '<',\n  '>=': '>=',\n  '<=': '<=',\n  IN: 'IN',\n  'NOT IN': 'NOT IN',\n  LIKE: 'LIKE',\n  ILIKE: 'ILIKE',\n  REGEX: 'REGEX',\n  'IS NOT NULL': 'IS NOT NULL',\n  'IS NULL': 'IS NULL',\n  'IS TRUE': 'IS TRUE',\n  'IS FALSE': 'IS FALSE',\n  'LATEST PARTITION': ({ datasource }) =>\n  `= '{{ presto.latest_partition('${datasource.schema}.${datasource.datasource_name}') }}'` };\n\n\nconst CUSTOM_OPERATIONS = [...CUSTOM_OPERATORS].map(\n(op) => OPERATOR_ENUM_TO_OPERATOR_TYPE[op].operation);\n\n\nfunction translateToSql(adhocMetric, { useSimple } = {}) {\n  if (adhocMetric.expressionType === EXPRESSION_TYPES.SIMPLE || useSimple) {\n    const { subject, comparator } = adhocMetric;\n    const operator =\n    adhocMetric.operator &&\n    CUSTOM_OPERATIONS.indexOf(adhocMetric.operator) >= 0 ?\n    OPERATORS_TO_SQL[adhocMetric.operator](adhocMetric) :\n    OPERATORS_TO_SQL[adhocMetric.operator];\n    return getSimpleSQLExpression(subject, operator, comparator);\n  }\n  if (adhocMetric.expressionType === EXPRESSION_TYPES.SQL) {\n    return adhocMetric.sqlExpression;\n  }\n  return '';\n}\n\nexport default class AdhocFilter {\n  constructor(adhocFilter) {\n    this.expressionType = adhocFilter.expressionType || EXPRESSION_TYPES.SIMPLE;\n    if (this.expressionType === EXPRESSION_TYPES.SIMPLE) {var _adhocFilter$operator;\n      this.subject = adhocFilter.subject;\n      this.operator = (_adhocFilter$operator = adhocFilter.operator) == null ? void 0 : _adhocFilter$operator.toUpperCase();\n      this.operatorId = adhocFilter.operatorId;\n      this.comparator = adhocFilter.comparator;\n      if (\n      [Operators.IS_TRUE, Operators.IS_FALSE].indexOf(\n      adhocFilter.operatorId) >=\n      0)\n      {\n        this.comparator = adhocFilter.operatorId === Operators.IS_TRUE;\n      }\n      if (\n      [Operators.IS_NULL, Operators.IS_NOT_NULL].indexOf(\n      adhocFilter.operatorId) >=\n      0)\n      {\n        this.comparator = null;\n      }\n      this.clause = adhocFilter.clause || CLAUSES.WHERE;\n      this.sqlExpression = null;\n    } else if (this.expressionType === EXPRESSION_TYPES.SQL) {\n      this.sqlExpression =\n      typeof adhocFilter.sqlExpression === 'string' ?\n      adhocFilter.sqlExpression :\n      translateToSql(adhocFilter, { useSimple: true });\n      this.clause = adhocFilter.clause;\n      if (\n      adhocFilter.operator &&\n      CUSTOM_OPERATIONS.indexOf(adhocFilter.operator) >= 0)\n      {\n        this.subject = adhocFilter.subject;\n        this.operator = adhocFilter.operator;\n        this.operatorId = adhocFilter.operatorId;\n      } else {\n        this.subject = null;\n        this.operator = null;\n      }\n      this.comparator = null;\n    }\n    this.isExtra = !!adhocFilter.isExtra;\n    this.isNew = !!adhocFilter.isNew;\n\n    this.filterOptionName =\n    adhocFilter.filterOptionName ||\n    `filter_${Math.random().\n    toString(36).\n    substring(2, 15)}_${Math.random().toString(36).substring(2, 15)}`;\n  }\n\n  duplicateWith(nextFields) {\n    return new AdhocFilter({\n      ...this,\n      // all duplicated fields are not new (i.e. will not open popup automatically)\n      isNew: false,\n      ...nextFields });\n\n  }\n\n  equals(adhocFilter) {\n    return (\n      adhocFilter.expressionType === this.expressionType &&\n      adhocFilter.sqlExpression === this.sqlExpression &&\n      adhocFilter.operator === this.operator &&\n      adhocFilter.operatorId === this.operatorId &&\n      adhocFilter.comparator === this.comparator &&\n      adhocFilter.subject === this.subject);\n\n  }\n\n  isValid() {\n    const nullCheckOperators = [Operators.IS_NOT_NULL, Operators.IS_NULL].map(\n    (op) => OPERATOR_ENUM_TO_OPERATOR_TYPE[op].operation);\n\n    const truthCheckOperators = [Operators.IS_TRUE, Operators.IS_FALSE].map(\n    (op) => OPERATOR_ENUM_TO_OPERATOR_TYPE[op].operation);\n\n    if (this.expressionType === EXPRESSION_TYPES.SIMPLE) {\n      if (nullCheckOperators.indexOf(this.operator) >= 0) {\n        return !!(this.operator && this.subject);\n      }\n      if (truthCheckOperators.indexOf(this.operator) >= 0) {\n        return !!(this.subject && this.comparator !== null);\n      }\n      if (this.operator && this.subject && this.clause) {\n        if (Array.isArray(this.comparator)) {\n          if (this.comparator.length > 0) {\n            // A non-empty array of values ('IN' or 'NOT IN' clauses)\n            return true;\n          }\n        } else if (this.comparator !== null) {\n          // A value has been selected or typed\n          return true;\n        }\n      }\n    } else if (this.expressionType === EXPRESSION_TYPES.SQL) {\n      return !!(this.sqlExpression && this.clause);\n    }\n    return false;\n  }\n\n  getDefaultLabel() {\n    const label = this.translateToSql();\n    return label.length < 43 ? label : `${label.substring(0, 40)}...`;\n  }\n\n  getTooltipTitle() {\n    return this.translateToSql();\n  }\n\n  translateToSql() {\n    return translateToSql(this);\n  }}","map":null,"metadata":{},"sourceType":"module"}